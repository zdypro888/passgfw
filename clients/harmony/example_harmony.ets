/**
 * PassGFW HarmonyOS Example
 *
 * ä¸€ä¸ªæ¼”ç¤º PassGFW åœ¨ HarmonyOS ä¸Šä½¿ç”¨çš„ç¤ºä¾‹é¡µé¢
 *
 * é›†æˆæ­¥éª¤:
 * 1. å°† PassGFW HAR åŒ…æ·»åŠ åˆ°é¡¹ç›®
 * 2. åœ¨ module.json5 æ·»åŠ ç½‘ç»œæƒé™:
 *    "requestPermissions": [
 *      { "name": "ohos.permission.INTERNET" }
 *    ]
 *
 * 3. åœ¨é¡µé¢ä¸­ä½¿ç”¨:
 *    import { PassGFW } from '@ohos/passgfw'
 *    const passGFW = new PassGFW()
 *    await passGFW.initialize(this.context)
 *    const domain = await passGFW.getFinalServer("custom-data")
 *
 * åŠŸèƒ½æ¼”ç¤º:
 *   - åŸºæœ¬é˜²ç«å¢™æ£€æµ‹
 *   - è‡ªå®šä¹‰ URL åˆ—è¡¨
 *   - çŠ¶æ€ç®¡ç†
 *   - é”™è¯¯å¤„ç†
 */

import { PassGFW, URLEntry, LogLevel } from '@ohos/passgfw'
import { common } from '@kit.AbilityKit'

@Entry
@Component
struct PassGFWExample {
  @State statusText: string = 'å°±ç»ªï¼šç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æµ‹'
  @State foundDomain: string = ''
  @State isDetecting: boolean = false

  private passGFW: PassGFW = new PassGFW()
  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

  async aboutToAppear() {
    try {
      // åˆå§‹åŒ– PassGFWï¼ˆå¿…é¡»ï¼‰
      await this.passGFW.initialize(this.context)

      // é…ç½®æ—¥å¿—çº§åˆ«
      this.passGFW.setLogLevel(LogLevel.INFO)

      console.info('[PassGFWExample] Initialized successfully')
    } catch (error) {
      console.error('[PassGFWExample] Initialization failed:', error.message)
      this.statusText = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message
    }
  }

  /**
   * ç¤ºä¾‹ 1: åŸºæœ¬é˜²ç«å¢™æ£€æµ‹
   */
  async startBasicDetection() {
    if (this.isDetecting) return

    this.isDetecting = true
    this.statusText = 'ðŸ” å¼€å§‹é˜²ç«å¢™æ£€æµ‹...'
    this.foundDomain = ''

    try {
      const domain = await this.passGFW.getFinalServer('harmony-example-v2.0')

      if (domain) {
        this.statusText = 'âœ… æ‰¾åˆ°å¯ç”¨æœåŠ¡å™¨'
        this.foundDomain = domain
        console.info('[PassGFWExample] Found server:', domain)
      } else {
        const error = this.passGFW.getLastError() || 'æœªçŸ¥é”™è¯¯'
        this.statusText = 'âŒ æ£€æµ‹å¤±è´¥: ' + error
        console.error('[PassGFWExample] Detection failed:', error)
      }
    } catch (error) {
      this.statusText = 'âŒ å¼‚å¸¸: ' + error.message
      console.error('[PassGFWExample] Exception:', error)
    } finally {
      this.isDetecting = false
    }
  }

  /**
   * ç¤ºä¾‹ 2: ä½¿ç”¨è‡ªå®šä¹‰ URL åˆ—è¡¨
   */
  async startCustomURLDetection() {
    if (this.isDetecting) return

    this.isDetecting = true
    this.statusText = 'ðŸ” ä½¿ç”¨è‡ªå®šä¹‰ URL åˆ—è¡¨...'

    try {
      // åˆ›å»ºè‡ªå®šä¹‰ URL åˆ—è¡¨
      const customURLs: URLEntry[] = [
        { method: 'navigate', url: 'https://github.com/zdypro888/passgfw' },
        { method: 'api', url: 'http://192.168.1.1:8080/passgfw' },
        { method: 'api', url: 'http://10.0.0.1:8080/passgfw' },
        { method: 'file', url: 'http://cdn.example.com/list.txt', store: true }
      ]

      this.passGFW.setURLList(customURLs)

      const domain = await this.passGFW.getFinalServer('custom-urls-example')

      if (domain) {
        this.statusText = 'âœ… æˆåŠŸ: ' + domain
        this.foundDomain = domain
      } else {
        this.statusText = 'âŒ æ‰€æœ‰ URL æ£€æµ‹å¤±è´¥'
      }
    } catch (error) {
      this.statusText = 'âŒ å¼‚å¸¸: ' + error.message
    } finally {
      this.isDetecting = false
    }
  }

  /**
   * ç¤ºä¾‹ 3: åŠ¨æ€æ·»åŠ  URL
   */
  addDynamicURLs() {
    this.passGFW.addURL('api', 'http://backup-server.example.com/passgfw')
    this.passGFW.addURL('api', 'http://another-server.example.com/passgfw')

    this.statusText = 'âž• åŠ¨æ€æ·»åŠ äº† 2 ä¸ª URL'
    console.info('[PassGFWExample] Added 2 dynamic URLs')
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('PassGFW HarmonyOS ç¤ºä¾‹')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 30 })

      // çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
      Column() {
        Text('çŠ¶æ€:')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 10 })
          .alignSelf(ItemAlign.Start)

        Text(this.statusText)
          .fontSize(16)
          .fontColor(Color.Gray)
          .padding(16)
          .width('100%')
          .backgroundColor('#f0f0f0')
          .borderRadius(8)

        if (this.foundDomain) {
          Row() {
            Text('æœåŠ¡å™¨:')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
            Text(this.foundDomain)
              .fontSize(16)
              .fontColor('#007AFF')
              .margin({ left: 8 })
          }
          .margin({ top: 10 })
          .alignSelf(ItemAlign.Start)
        }
      }
      .padding({ left: 20, right: 20 })
      .margin({ bottom: 30 })

      // æŒ‰é’®ç»„
      Column({ space: 15 }) {
        // åŸºæœ¬æ£€æµ‹æŒ‰é’®
        Button('åŸºæœ¬æ£€æµ‹')
          .width('90%')
          .height(50)
          .fontSize(18)
          .backgroundColor('#007AFF')
          .enabled(!this.isDetecting)
          .onClick(() => {
            this.startBasicDetection()
          })

        // è‡ªå®šä¹‰ URL æ£€æµ‹æŒ‰é’®
        Button('è‡ªå®šä¹‰ URL æ£€æµ‹')
          .width('90%')
          .height(50)
          .fontSize(18)
          .backgroundColor('#34C759')
          .enabled(!this.isDetecting)
          .onClick(() => {
            this.startCustomURLDetection()
          })

        // åŠ¨æ€æ·»åŠ  URL æŒ‰é’®
        Button('åŠ¨æ€æ·»åŠ  URL')
          .width('90%')
          .height(50)
          .fontSize(18)
          .backgroundColor('#FF9500')
          .enabled(!this.isDetecting)
          .onClick(() => {
            this.addDynamicURLs()
          })
      }
      .width('100%')
      .margin({ bottom: 30 })

      // åŠ è½½æŒ‡ç¤ºå™¨
      if (this.isDetecting) {
        LoadingProgress()
          .width(40)
          .height(40)
          .margin({ top: 20 })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White)
  }
}
